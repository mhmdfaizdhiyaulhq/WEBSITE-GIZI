<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GiziPoin - Scan Barcode</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link href="style.css" rel="stylesheet">
  </head>
  <body>

    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">GiziPoin</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
            <li class="nav-item"><a class="nav-link active" href="scan.html">Scan</a></li>
            <li class="nav-item"><a class="nav-link" href="kontak.html">Kontak</a></li>
            <li class="nav-item"><a class="nav-link" href="login.html" id="nav-login-logout">Login</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="text-center">
        <h2>Scan Barcode</h2>
        <p class="text-muted">Arahkan kamera ke barcode produk makanan.</p>
      </div>
      
      <div id="reader"></div>
      
      <div id="scan-results" class="mt-4">
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

    <script>
      // Helper function untuk membuat 1 baris fakta gizi
      function createNutriItem(name, value, unit = 'g') {
        if (!value || parseFloat(value) === 0) {
          return ''; 
        }
        return `
          <li class="list-group-item nutrition-item">
            <span><i class="bi bi-dot"></i> ${name}</span>
            <span class="nutrition-value">${value} ${unit}</span>
          </li>
        `;
      }

      // Fungsi yang dipanggil saat scan berhasil
      function onScanSuccess(decodedText, decodedResult) {
        html5QrcodeScanner.clear();
        cariInfoGizi(decodedText);
      }

      // Fungsi untuk memanggil API dan menampilkan hasil
      async function cariInfoGizi(barcode) {
        const hasilElement = document.getElementById('scan-results');
        
        // 1. Tampilkan LOADING SPINNER
        hasilElement.innerHTML = `
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Mencari data untuk ${barcode}...</p>
          </div>
        `;

        try {
          const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
          const data = await response.json();

          if (data.status === 1) {
            // 2. DATA DITEMUKAN
            const product = data.product;
            const gizi = product.nutriments;
            const imageUrl = product.image_front_small_url || 'https://via.placeholder.com/80x80.png?text=No+Image';

            hasilElement.innerHTML = `
              <div class="card nutrition-card">
                <div class="card-header nutrition-header">
                  <div class="d-flex align-items-center">
                    <img src="${imageUrl}" alt="${product.product_name}" class="me-3">
                    <h5>${product.product_name || 'Nama Produk Tidak Dikenal'}</h5>
                  </div>
                </div>
                <div class="card-body">
                  <h6 class="mb-3">Informasi Gizi (per 100g)</h6>
                  <ul class="list-group list-group-flush nutrition-facts">
                    ${createNutriItem('Kalori', gizi['energy-kcal_100g'], 'kcal')}
                    ${createNutriItem('Lemak', gizi.fat_100g, 'g')}
                    ${createNutriItem('Karbohidrat', gizi.carbohydrates_100g, 'g')}
                    ${createNutriItem('Gula', gizi.sugars_100g, 'g')}
                    ${createNutriItem('Protein', gizi.proteins_100g, 'g')}
                    ${createNutriItem('Garam', gizi.salt_100g, 'g')}
                  </ul>
                </div>
              </div>
            `;
          } else {
            // 3. DATA TIDAK DITEMUKAN
            hasilElement.innerHTML = `
              <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Produk Tidak Ditemukan</h4>
                <p>Maaf, produk dengan barcode <strong>${barcode}</strong> tidak ada di database kami.</p>
              </div>
            `;
          }
        } catch (error) {
          // 4. TERJADI ERROR
          console.error("Error fetching data:", error);
          hasilElement.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <strong>Oops!</strong> Terjadi kesalahan saat mengambil data. Silakan coba lagi.
            </div>
          `;
        }
      }

      // Inisialisasi Scanner
      var html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { 
          fps: 10, 
          qrbox: 250 
        }
      );
      html5QrcodeScanner.render(onScanSuccess);
    </script>
    <script type="module" src="auth.js"></script>
  </body>
</html>